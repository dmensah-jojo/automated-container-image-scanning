on: [push, workflow_dispatch]

env:
  IMAGE_NAME: ${{ github.repository }}:${{ github.sha }}

jobs:
  build-and-scan:
    name: Build and scan image
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Locate Dockerfile
        id: dockerfile
        shell: bash
        run: |
          set -euo pipefail

          # Find a file named exactly "Dockerfile" (case-sensitive), anywhere in the repo.
          DOCKERFILE_PATH="$(git ls-files | grep -E '(^|/)Dockerfile$' | head -n 1 || true)"

          if [[ -z "${DOCKERFILE_PATH}" ]]; then
            echo "::error::Dockerfile not found. Ensure a file named 'Dockerfile' exists (case-sensitive)."
            exit 1
          fi

          CONTEXT_DIR="$(dirname "${DOCKERFILE_PATH}")"
          if [[ "${CONTEXT_DIR}" == "." ]]; then CONTEXT_DIR="."; fi

          echo "Found Dockerfile at: ${DOCKERFILE_PATH}"
          echo "Using build context: ${CONTEXT_DIR}"

          echo "path=${DOCKERFILE_PATH}" >> "${GITHUB_OUTPUT}"
          echo "context=${CONTEXT_DIR}" >> "${GITHUB_OUTPUT}"

      - name: Build the image
        shell: bash
        run: |
          set -euo pipefail
          docker build \
            -t "${IMAGE_NAME}" \
            -f "${{ steps.dockerfile.outputs.path }}" \
            "${{ steps.dockerfile.outputs.context }}"

      - name: Prisma Cloud image scan
        id: scan
        uses: PaloAltoNetworks/prisma-cloud-scan@v1.5
        with:
          pcc_console_url: ${{ secrets.PCC_CONSOLE_URL }}
          pcc_user: ${{ secrets.PCC_USER }}
          pcc_pass: ${{ secrets.PCC_PASS }}
          image_name: ${{ env.IMAGE_NAME }}

      - name: Upload SARIF file
        # Only run if the scan step produced a SARIF output
        if: ${{ always() && steps.scan.outputs.sarif_file != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.scan.outputs.sarif_file }}



