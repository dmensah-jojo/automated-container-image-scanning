on: [push, workflow_dispatch]

env:
  IMAGE_NAME: ${{ github.repository }}:${{ github.sha }}

jobs:
  build-and-scan:
    name: Build and scan image
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Locate or generate Dockerfile
        id: dockerfile
        shell: bash
        run: |
          set -euo pipefail

          # 1) Find tracked Dockerfile (case-sensitive)
          DOCKERFILE_PATH="$(git ls-files | grep -E '(^|/)Dockerfile$' | head -n 1 || true)"

          # 2) If not tracked, find any Dockerfile in workspace
          if [[ -z "${DOCKERFILE_PATH}" ]]; then
            DOCKERFILE_PATH="$(find . -type f -name Dockerfile -print | sed 's|^\./||' | head -n 1 || true)"
          fi

          # 3) If still not found, generate a fallback Dockerfile
          if [[ -z "${DOCKERFILE_PATH}" ]]; then
            echo "::warning::Dockerfile not found. Generating fallback Dockerfile."

            cat <<'EOF' > Dockerfile
          FROM alpine:3.20

          WORKDIR /app
          COPY . /app

          CMD ["sh"]
          EOF

            DOCKERFILE_PATH="Dockerfile"
          fi

          CONTEXT_DIR="$(dirname "${DOCKERFILE_PATH}")"
          if [[ "${CONTEXT_DIR}" == "." ]]; then CONTEXT_DIR="."; fi

          echo "path=${DOCKERFILE_PATH}" >> "$GITHUB_OUTPUT"
          echo "context=${CONTEXT_DIR}" >> "$GITHUB_OUTPUT"

      - name: Build the image
        shell: bash
        run: |
          set -euo pipefail
          docker build \
            -t "${IMAGE_NAME}" \
            -f "${{ steps.dockerfile.outputs.path }}" \
            "${{ steps.dockerfile.outputs.context }}"

      - name: Prisma Cloud image scan
        id: scan
        uses: PaloAltoNetworks/prisma-cloud-scan@v1.5
        with:
          pcc_console_url: ${{ secrets.PCC_CONSOLE_URL }}
          pcc_user: ${{ secrets.PCC_USER }}
          pcc_pass: ${{ secrets.PCC_PASS }}
          image_name: ${{ env.IMAGE_NAME }}

      - name: Upload SARIF file
        if: ${{ always() && steps.scan.outputs.sarif_file != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.scan.outputs.sarif_file }}








